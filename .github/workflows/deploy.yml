name: Deploy System

on:
  push:
    branches: [ "main" ]
    paths:
      - 'backend-school/**'
      - 'backend-admin/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  # 1. Check Changes
  changes:
    runs-on: ubuntu-latest
    outputs:
      school: ${{ steps.filter.outputs.school }}
      admin: ${{ steps.filter.outputs.admin }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            school:
              - 'backend-school/**'
            admin:
              - 'backend-admin/**'

  # 2. Build School (Only if needed)
  build-school:
    needs: changes
    if: ${{ needs.changes.outputs.school == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/metadata-action@v5
        id: meta
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}-backend-school
          tags: type=raw,value=latest
      - uses: docker/build-push-action@v5
        with:
          context: ./backend-school
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=backend-school
          cache-to: type=gha,mode=max,scope=backend-school

  # 3. Build Admin (Only if needed)
  build-admin:
    needs: changes
    if: ${{ needs.changes.outputs.admin == 'true' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/metadata-action@v5
        id: meta
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}-backend-admin
          tags: type=raw,value=latest
      - uses: docker/build-push-action@v5
        with:
          context: ./backend-admin
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=backend-admin
          cache-to: type=gha,mode=max,scope=backend-admin

  # 4. Deploy (Runs if EITHER build succeeded OR skipped)
  deploy:
    needs: [build-school, build-admin]
    if: |
      always() && 
      (needs.build-school.result == 'success' || needs.build-school.result == 'skipped') && 
      (needs.build-admin.result == 'success' || needs.build-admin.result == 'skipped') &&
      !(needs.build-school.result == 'skipped' && needs.build-admin.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "${{ secrets.GITHUB_TOKEN }}" | podman login ghcr.io -u ${{ github.actor }} --password-stdin
            cd /opt/stack
            podman-compose pull
            podman-compose up -d --remove-orphans
            podman image prune -f
