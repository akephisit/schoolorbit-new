name: Deploy Backend School to Portainer

on:
  push:
    branches:
      - main
    paths:
      - 'backend-school/**'
      - '.github/workflows/deploy-backend-school.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/schoolorbit-backend-school

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend-school
          file: ./backend-school/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Deploy to Portainer via Webhook
        if: github.ref == 'refs/heads/main'
        env:
          PORTAINER_WEBHOOK_URL: ${{ secrets.PORTAINER_WEBHOOK_URL_SCHOOL }}
        run: |
          echo "Triggering Portainer webhook deployment..."
          curl -X POST "$PORTAINER_WEBHOOK_URL"
          echo "Deployment webhook triggered successfully!"

      - name: Wait for backend to be ready
        if: github.ref == 'refs/heads/main'
        run: |
          echo "â³ Waiting for Portainer to pull and deploy new image..."
          echo "   This may take 3-5 minutes..."
          sleep 180  # 3 minutes for Portainer to pull image
          
          echo "ðŸ” Checking backend health..."
          
          # Health check with extended retries (up to 5 minutes total wait)
          MAX_RETRIES=30
          RETRY_DELAY=10
          
          for i in $(seq 1 $MAX_RETRIES); do
            if curl -f https://school-api.schoolorbit.app/health > /dev/null 2>&1; then
              echo "âœ… Backend is healthy (attempt $i/$MAX_RETRIES)"
              
              # Extra verification - check if it's actually the new version
              sleep 5
              if curl -f https://school-api.schoolorbit.app/health > /dev/null 2>&1; then
                echo "âœ… Backend confirmed healthy and stable"
                break
              fi
            fi
            
            if [ $i -eq $MAX_RETRIES ]; then
              echo "âŒ Backend health check failed after $((MAX_RETRIES * RETRY_DELAY))s"
              echo "âš ï¸ Portainer may still be deploying. Check manually:"
              echo "   https://school-api.schoolorbit.app/health"
              exit 1
            fi
            
            echo "â³ Retry $i/$MAX_RETRIES... (waiting ${RETRY_DELAY}s)"
            sleep $RETRY_DELAY
          done
          
          echo "âœ… Backend is ready for migration"

      - name: Run database migrations
        if: github.ref == 'refs/heads/main'
        id: migrate
        run: |
          echo "ðŸ”„ Running database migrations for all schools..."
          
          RESPONSE=$(curl -X POST https://school-api.schoolorbit.app/internal/migrate-all \
            -H "X-Internal-Secret: ${{ secrets.INTERNAL_API_SECRET }}" \
            -H "Content-Type: application/json" \
            -w "\n%{http_code}" \
            -s)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ Migration API failed (HTTP $HTTP_CODE)"
            exit 1
          fi
          
          # Parse results
          TOTAL=$(echo "$BODY" | jq -r '.total // 0')
          SUCCESS=$(echo "$BODY" | jq -r '.success // 0')
          FAILED=$(echo "$BODY" | jq -r '.failed // 0')
          VERSION=$(echo "$BODY" | jq -r '.latest_version // 0')
          
          echo "ðŸ“Š Migration Results:"
          echo "   Total: $TOTAL | Success: $SUCCESS | Failed: $FAILED | Version: v$VERSION"
          
          # Store for summary
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "response=$BODY" >> $GITHUB_OUTPUT
          
          # Warn if failures
          if [ "$FAILED" -gt 0 ]; then
            echo "âš ï¸ $FAILED school(s) failed to migrate"
            echo "$BODY" | jq -r '.results[] | select(.status == "failed") | "  âŒ \(.subdomain): \(.error)"'
            echo "::warning::$FAILED schools failed to migrate"
          fi
          
          if [ "$SUCCESS" -eq "$TOTAL" ]; then
            echo "âœ… All schools migrated successfully!"
          fi

      - name: Deployment Summary
        if: always() && github.ref == 'refs/heads/main'
        run: |
          echo "## Deployment Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Docker Image" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.migrate.outcome }}" == "success" ]; then
            echo "### ðŸ“Š Migration Results" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Schools**: ${{ steps.migrate.outputs.total }}" >> $GITHUB_STEP_SUMMARY
            echo "- **âœ… Successful**: ${{ steps.migrate.outputs.success }}" >> $GITHUB_STEP_SUMMARY
            echo "- **âŒ Failed**: ${{ steps.migrate.outputs.failed }}" >> $GITHUB_STEP_SUMMARY
            echo "- **ðŸ“Œ Version**: v${{ steps.migrate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.migrate.outputs.failed }}" != "0" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### âš ï¸ Failed Schools" >> $GITHUB_STEP_SUMMARY
              echo '```json' >> $GITHUB_STEP_SUMMARY
              echo '${{ steps.migrate.outputs.response }}' | jq '.results[] | select(.status == "failed")' >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### â„¹ï¸ Migration Status" >> $GITHUB_STEP_SUMMARY
            echo "Migration step was skipped or failed. Check workflow logs." >> $GITHUB_STEP_SUMMARY
          fi
