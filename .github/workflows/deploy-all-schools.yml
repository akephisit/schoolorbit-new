name: Deploy Frontend School to All Tenants

on:
  # Trigger à¹€à¸¡à¸·à¹ˆà¸­ push à¹„à¸› main à¹à¸¥à¸°à¸¡à¸µà¸à¸²à¸£à¹à¸à¹‰à¹„à¸‚ frontend-school
  push:
    branches:
      - main
    paths:
      - 'frontend-school/**'
      - '.github/workflows/deploy-all-schools.yml'
  
  # à¸«à¸£à¸·à¸­ trigger manual
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy to all schools'
        required: false
        default: 'false'

jobs:
  get-schools:
    runs-on: ubuntu-latest
    outputs:
      schools: ${{ steps.fetch-schools.outputs.schools }}
    
    steps:
      - name: Fetch school list from API
        id: fetch-schools
        run: |
          echo "Fetching schools from API..."
          
          # Call internal API endpoint to get list of active schools
          RESPONSE=$(curl -s -X GET \
            "${{ secrets.BACKEND_ADMIN_URL }}/internal/schools?status=active" \
            -H "X-Internal-Secret: ${{ secrets.INTERNAL_API_SECRET }}" \
            -w "\n%{http_code}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status: $HTTP_CODE"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ API request failed with status $HTTP_CODE"
            echo "Response: $BODY"
            echo "schools=[]" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Parse response and extract schools
          SCHOOLS=$(echo "$BODY" | jq -c '.schools // [] | map({subdomain: .subdomain, school_id: .id})')
          
          if [ -z "$SCHOOLS" ] || [ "$SCHOOLS" = "null" ]; then
            echo "âš ï¸  No schools found or invalid response"
            echo "schools=[]" >> $GITHUB_OUTPUT
          else
            echo "schools=$SCHOOLS" >> $GITHUB_OUTPUT
            echo "âœ… Found schools to deploy:"
            echo "$SCHOOLS" | jq '.'
          fi

  deploy:
    needs: get-schools
    runs-on: ubuntu-latest
    if: needs.get-schools.outputs.schools != '[]' && needs.get-schools.outputs.schools != ''
    strategy:
      matrix:
        school: ${{ fromJson(needs.get-schools.outputs.schools) }}
      max-parallel: 3  # Deploy à¸ªà¸¹à¸‡à¸ªà¸¸à¸” 3 à¹‚à¸£à¸‡à¹€à¸£à¸µà¸¢à¸™à¸žà¸£à¹‰à¸­à¸¡à¸à¸±à¸™
      fail-fast: false  # à¸–à¹‰à¸² deploy à¹‚à¸£à¸‡à¹€à¸£à¸µà¸¢à¸™à¹ƒà¸”à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§ à¹ƒà¸«à¹‰ deploy à¹‚à¸£à¸‡à¹€à¸£à¸µà¸¢à¸™à¸­à¸·à¹ˆà¸™à¸•à¹ˆà¸­
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend-school/package-lock.json
      
      - name: Install dependencies
        working-directory: frontend-school
        run: npm ci
      
      - name: Create Wrangler configuration
        working-directory: frontend-school
        run: |
          cat > wrangler.json <<EOF
          {
            "name": "schoolorbit-school-${{ matrix.school.subdomain }}",
            "account_id": "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}",
            "main": "build/index.js",
            "build": {
              "command": "npm run build"
            },
            "compatibility_date": "2025-09-15",
            "compatibility_flags": ["nodejs_compat"],
            "assets": {
              "directory": "build/client",
              "binding": "ASSETS"
            },
            "routes": [
              {
                "pattern": "${{ matrix.school.subdomain }}.schoolorbit.app/*",
                "zone_name": "schoolorbit.app"
              }
            ],
            "vars": {
              "PUBLIC_BACKEND_URL": "${{ secrets.BACKEND_SCHOOL_URL }}",
              "SCHOOL_ID": "${{ matrix.school.school_id }}",
              "SUBDOMAIN": "${{ matrix.school.subdomain }}"
            }
          }
          EOF
      
      - name: Build frontend
        working-directory: frontend-school
        env:
          PUBLIC_BACKEND_URL: ${{ secrets.BACKEND_SCHOOL_URL }}
        run: npm run build
      
      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          workingDirectory: frontend-school
          command: deploy
      
      - name: Report deployment status
        if: success()
        run: |
          echo "âœ… Successfully deployed ${{ matrix.school.subdomain }}"
          echo "URL: https://${{ matrix.school.subdomain }}.schoolorbit.app"
      
      - name: Report deployment failure
        if: failure()
        run: |
          echo "âŒ Deployment failed for ${{ matrix.school.subdomain }}"

  summary:
    needs: [get-schools, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Deployment summary
        run: |
          SCHOOLS='${{ needs.get-schools.outputs.schools }}'
          SCHOOL_COUNT=$(echo "$SCHOOLS" | jq '. | length')
          echo "ðŸŽ‰ Deployment completed!"
          echo "Schools processed: $SCHOOL_COUNT"
